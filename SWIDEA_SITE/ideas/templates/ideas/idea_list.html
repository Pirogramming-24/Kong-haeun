{% extends 'base.html' %}

{% block title %}Idea List{% endblock %}

{% block content %}
<h2>Idea List</h2>

<!-- 정렬 -->
<select onchange="location.href='?sort=' + this.value">
    <option value="latest" {% if sort == 'latest' %}selected{% endif %}>최신순</option>
    <option value="title" {% if sort == 'title' %}selected{% endif %}>이름순</option>
    <option value="interest" {% if sort == 'interest' %}selected{% endif %}>관심도순</option>
</select>

<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:20px;">
    {% for idea in ideas %}
    
    <div style="background:white; padding:15px; border-radius:8px; position:relative;">

        <!-- 찜 -->
        <div style="position:absolute; top:10px; right:10px;">
            <a href="{% url 'ideas:favorite' idea.id %}">
                {% if idea.id in favorites %}★{% else %}☆{% endif %}
            </a>
        </div>

        {% if idea.image %}
            <img src="{{ idea.image.url }}" style="width:100%; height:140px; object-fit:cover;">
        {% else %}
            <div style="height:140px; background:#ddd;"></div>
        {% endif %}
      
        <h4>
            <a href="{% url 'ideas:detail' idea.id %}">
                {{ idea.title }}
            </a>
        </h4>
        
        <p>
            관심도:
            <button class="interest-btn"
                    data-id="{{ idea.id }}"
                    data-action="minus">-</button>

            <span id="interest-{{ idea.id }}">
                {{ idea.interest }}
            </span>

            <button class="interest-btn"
                    data-id="{{ idea.id }}"
                    data-action="plus">+</button>
        </p>

        <p>
            개발툴:
            {% if idea.devtool %}
                {{ idea.devtool.name }}
            {% else %}
                없음
            {% endif %}
        </p>

    </div>
    {% endfor %}
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

document.querySelectorAll('.interest-btn').forEach(button => {
    button.addEventListener('click', function () {
        const ideaId = this.dataset.id;
        const action = this.dataset.action;

        fetch(`/${ideaId}/interest/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=${action}`
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById(`interest-${ideaId}`).innerText = data.interest;
        });
    });
});
</script>

{% endblock %}
